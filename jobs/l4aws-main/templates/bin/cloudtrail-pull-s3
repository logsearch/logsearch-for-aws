#!/bin/bash

# args: s3-bucket s3-object-key

set -e
set -u

S3_ENDPOINT="<%= p('l4aws.s3_endpoint') %>"
S3_ACCESS_KEY_ID="<%= p('l4aws.access_key_id') %>"
S3_SECRET_ACCESS_KEY="<%= p('l4aws.secret_access_key') %>"

S3_BUCKET="${1}"
S3_OBJECT_KEY="${2}"

cd /var/vcap/store/l4aws-main/cloudtrail

# clean up older files
find . -mtime +5 -exec rm {} \;

S3GO_NOW=$( date -R )
S3GO_SIGNATURE=$(
  echo -en "GET\n\n\n${S3GO_NOW}\n/${S3_BUCKET}/${S3_OBJECT_KEY}" \
    | openssl sha1 -hmac "${S3_SECRET_ACCESS_KEY}" -binary \
    | openssl enc -e -base64
)

curl \
  -s \
  -H "Date: ${S3GO_NOW}" \
  -H "Authorization: AWS ${S3_ACCESS_KEY_ID}:${S3GO_SIGNATURE}" \
  "https://${S3_ENDPOINT}/${S3_BUCKET}/${S3_OBJECT_KEY}" \
  | gunzip -c \
  | /var/vcap/packages/l4aws-jq/jq -c '.Records[] | .' \
  > $( basename "${S3_OBJECT_KEY}" ).log
